name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  WORKER_NAME: grok-art-proxy

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create D1 Database (if not exists)
        id: create-d1
        run: |
          # Try to create D1 database, ignore if already exists
          OUTPUT=$(npx wrangler d1 create ${{ env.WORKER_NAME }} 2>&1) || true
          echo "$OUTPUT"

          # Extract database_id from output
          if echo "$OUTPUT" | grep -q "database_id"; then
            D1_ID=$(echo "$OUTPUT" | grep "database_id" | sed 's/.*= "\(.*\)"/\1/')
            echo "d1_id=$D1_ID" >> $GITHUB_OUTPUT
            echo "Created new D1 database: $D1_ID"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Create KV Namespace (if not exists)
        id: create-kv
        run: |
          # Try to create KV namespace, ignore if already exists
          OUTPUT=$(npx wrangler kv namespace create KV_CACHE 2>&1) || true
          echo "$OUTPUT"

          # Extract id from output
          if echo "$OUTPUT" | grep -q 'id = "'; then
            KV_ID=$(echo "$OUTPUT" | grep 'id = "' | sed 's/.*id = "\(.*\)"/\1/')
            echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT
            echo "Created new KV namespace: $KV_ID"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Get existing resource IDs
        id: get-resources
        run: |
          # Get D1 database ID
          D1_ID="${{ secrets.D1_DATABASE_ID }}"
          if [ -z "$D1_ID" ] && [ -n "${{ steps.create-d1.outputs.d1_id }}" ]; then
            D1_ID="${{ steps.create-d1.outputs.d1_id }}"
          fi

          # If still empty, try to find existing database
          if [ -z "$D1_ID" ]; then
            D1_ID=$(npx wrangler d1 list --json 2>/dev/null | jq -r '.[] | select(.name=="${{ env.WORKER_NAME }}") | .uuid' || echo "")
          fi

          # Get KV namespace ID
          KV_ID="${{ secrets.KV_NAMESPACE_ID }}"
          if [ -z "$KV_ID" ] && [ -n "${{ steps.create-kv.outputs.kv_id }}" ]; then
            KV_ID="${{ steps.create-kv.outputs.kv_id }}"
          fi

          # If still empty, try to find existing namespace
          if [ -z "$KV_ID" ]; then
            KV_ID=$(npx wrangler kv namespace list --json 2>/dev/null | jq -r '.[] | select(.title=="KV_CACHE") | .id' || echo "")
          fi

          echo "d1_id=$D1_ID" >> $GITHUB_OUTPUT
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT
          echo "D1 Database ID: $D1_ID"
          echo "KV Namespace ID: $KV_ID"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Update wrangler.toml
        run: |
          D1_ID="${{ steps.get-resources.outputs.d1_id }}"
          KV_ID="${{ steps.get-resources.outputs.kv_id }}"

          if [ -n "$D1_ID" ]; then
            sed -i "s/database_id = \"YOUR_D1_DATABASE_ID\"/database_id = \"$D1_ID\"/" wrangler.toml
            sed -i "s/database_id = \".*\"/database_id = \"$D1_ID\"/" wrangler.toml
          else
            echo "::error::D1 Database ID not found. Please set D1_DATABASE_ID secret."
            exit 1
          fi

          if [ -n "$KV_ID" ]; then
            sed -i "s/id = \"YOUR_KV_NAMESPACE_ID\"/id = \"$KV_ID\"/" wrangler.toml
            sed -i "s/^id = \".*\"/id = \"$KV_ID\"/" wrangler.toml
          else
            echo "::error::KV Namespace ID not found. Please set KV_NAMESPACE_ID secret."
            exit 1
          fi

          echo "Updated wrangler.toml:"
          cat wrangler.toml

      - name: Run D1 Migrations
        run: npx wrangler d1 migrations apply DB --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Workers
        run: npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Set Worker Secrets
        run: |
          if [ -n "${{ secrets.AUTH_USERNAME }}" ]; then
            echo "${{ secrets.AUTH_USERNAME }}" | npx wrangler secret put AUTH_USERNAME 2>/dev/null || \
            echo "${{ secrets.AUTH_USERNAME }}" | npx wrangler secret put AUTH_USERNAME --force 2>/dev/null || true
          fi

          if [ -n "${{ secrets.AUTH_PASSWORD }}" ]; then
            echo "${{ secrets.AUTH_PASSWORD }}" | npx wrangler secret put AUTH_PASSWORD 2>/dev/null || \
            echo "${{ secrets.AUTH_PASSWORD }}" | npx wrangler secret put AUTH_PASSWORD --force 2>/dev/null || true
          fi

          if [ -n "${{ secrets.XAI_API_KEY }}" ]; then
            echo "${{ secrets.XAI_API_KEY }}" | npx wrangler secret put XAI_API_KEY 2>/dev/null || \
            echo "${{ secrets.XAI_API_KEY }}" | npx wrangler secret put XAI_API_KEY --force 2>/dev/null || true
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access URL" >> $GITHUB_STEP_SUMMARY
          echo "https://${{ env.WORKER_NAME }}.<your-account>.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "- D1 Database: \`${{ steps.get-resources.outputs.d1_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- KV Namespace: \`${{ steps.get-resources.outputs.kv_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Login with your configured credentials" >> $GITHUB_STEP_SUMMARY
          echo "2. Add your Grok tokens to start generating images" >> $GITHUB_STEP_SUMMARY
